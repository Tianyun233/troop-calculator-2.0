<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bear Trap Calculator</title>
    <style>
        /* CSS æ ·å¼éƒ¨åˆ† (æœªæ”¹åŠ¨) */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; color: #333; padding: 20px; max-width: 800px; margin: 0 auto; }
        
        /* é¡¶éƒ¨å¸ƒå±€å®¹å™¨ */
        .top-bar-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        /* è¯­è¨€é€‰æ‹©å™¨ (å·¦ä¸Šè§’) */
        .lang-container { 
            text-align: left; 
        }
        .lang-container label { font-weight: bold; margin-right: 5px; color: #555; }
        select#langSelector { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }

        /* ç”¨æˆ·è®¤è¯åŒºåŸŸ (å³ä¸Šè§’) */
        #user-auth-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95em;
            color: #555;
            background: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        #authButton, #logoutButton {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: bold;
        }
        #authButton { background-color: #3498db; color: white; }
        #authButton:hover { background-color: #2980b9; }
        #logoutButton { background-color: #e74c3c; color: white; display: none; }
        #logoutButton:hover { background-color: #c0392b; }

        h1 { text-align: center; color: #2c3e50; margin-bottom: 5px; }
        .author-credit { text-align: center; color: #7f8c8d; margin-bottom: 20px; font-size: 1.1em; }
        
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .section-title { font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 5px; color: #555; }
        
        /* ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡†æ ·å¼ */
        #authModal {
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.7); 
            z-index: 1000; 
            justify-content: center; 
            align-items: center;
        }
        .modal-content {
            background: white; 
            padding: 30px; 
            border-radius: 8px; 
            width: 90%;
            max-width: 350px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .modal-content input[type="email"], .modal-content input[type="password"], .modal-content input[type="text"] {
            width: calc(100% - 20px); 
            padding: 10px; 
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .modal-content button {
            padding: 10px; 
            width: 100%; 
            background-color: #2ecc71; 
            color: white; 
            border: none; 
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .modal-content button:hover { background-color: #27ae60; }
        #toggleAuthMode { 
            text-align: center; 
            margin-top: 15px; 
            cursor: pointer; 
            color: #3498db; 
            font-size: 0.9em;
        }
        
        /* å…¶ä»–æ ·å¼ä¿æŒä¸å˜ */
        .input-group { display: flex; gap: 15px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
        .input-group label { font-weight: bold; min-width: 130px; }
        input[type="number"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100px; }
        input[type="checkbox"] { transform: scale(1.5); margin-right: 10px; }
        select.tier-select { padding: 8px; border-radius: 4px; border: 1px solid #aaa; background-color: #fff; min-width: 150px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 8px; text-align: center; border-bottom: 1px solid #eee; font-size: 0.95em; }
        th { background-color: #f8f9fa; color: #444; }
        input.table-input { width: 80%; padding: 5px; text-align: center; }
        .btn-calc { width: 100%; padding: 15px; background-color: #3498db; color: white; border: none; border-radius: 6px; font-size: 18px; cursor: pointer; transition: background 0.3s; margin-top: 20px; }
        .btn-calc:hover { background-color: #2980b9; }
        #result-area { display: none; background-color: #e8f6f3; border: 1px solid #a3e4d7; }
        .result-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1.1em; }
        .result-highlight { font-weight: bold; color: #d35400; }
        .notice { font-size: 0.9em; color: #7f8c8d; margin-top: 10px; font-style: italic; }
        .feedback-area { margin-top: 30px; padding: 20px; background-color: #f9f9f9; border-top: 1px solid #eee; }
        .feedback-area h3 { color: #2c3e50; margin-bottom: 15px; text-align: center; }
        .like-section { text-align: center; margin-bottom: 20px; }
        .like-section button { padding: 10px 20px; font-size: 1.1em; background-color: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
        .like-section button:hover { background-color: #c0392b; }
        .like-section span { font-size: 1.2em; font-weight: bold; margin-left: 10px; color: #e74c3c; }
        .comment-input-group { display: flex; margin-bottom: 15px; }
        .comment-input-group textarea { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; resize: vertical; min-height: 60px; }
        .comment-input-group button { margin-left: 10px; padding: 10px 15px; background-color: #2ecc71; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
        .comment-input-group button:hover { background-color: #27ae60; }
        .comments-list { max-height: 400px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 5px; background-color: #fff; }
        
        /* è¯„è®ºé¡¹ç›®æ ·å¼ */
        .comment-item { 
            border-bottom: 1px dashed #eee; 
            padding: 10px 0; 
            position: relative; /* ç”¨äºå®šä½æ“ä½œæŒ‰é’® */
        }
        .comment-item:last-child { border-bottom: none; }
        .comment-author { font-weight: bold; color: #3498db; }
        .comment-text { margin-top: 5px; line-height: 1.5; }
        .comment-time { font-size: 0.8em; color: #999; margin-top: 5px; }

        /* è¯„è®ºæ“ä½œæŒ‰é’®å®¹å™¨ */
        .comment-actions {
            position: absolute;
            bottom: 10px; /* ç§»åˆ°å³ä¸‹è§’ */
            right: 0;
            display: flex;
            gap: 10px;
        }
        .comment-actions button {
            background: none;
            border: none;
            color: #7f8c8d;
            cursor: pointer;
            font-size: 0.8em;
            padding: 0;
        }
        .comment-actions button:hover {
            color: #e74c3c;
        }
        
        @media (max-width: 600px) {
            .input-group { gap: 10px; }
            .input-group label { min-width: 100px; }
            th, td { padding: 5px; font-size: 0.85em; }
            .comment-input-group { flex-direction: column; }
            .comment-input-group button { margin-left: 0; margin-top: 10px; width: 100%; }
        }
    </style>
</head>
<body>
    
    <div class="top-bar-container">
        <div class="lang-container">
            <label for="langSelector">Language:</label>
            <select id="langSelector" onchange="changeLanguage(this.value)">
                <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
                <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                <option value="en">English</option>
                <option value="ja">æ—¥æœ¬èª</option>
                <option value="ko">í•œêµ­ì–´</option>
            </select>
        </div>

        <div id="user-auth-status">
            <span id="displayUserName" data-i18n="anonymous_user">åŒ¿åç”¨æˆ·</span>
            <button id="authButton" data-i18n="btn_login">ç™»å½•/æ³¨å†Œ</button>
            <button id="logoutButton" data-i18n="btn_logout" style="display: none;">ç™»å‡º</button>
        </div>
    </div>

    <h1 data-i18n="title">ğŸ» æ‰“ç†Šé…å…µæ¯”ä¾‹è®¡ç®—å™¨</h1>
    
    <p class="author-credit">
        <span data-i18n="author_label">ä½œè€…</span>: <span id="authorName">#46 çƒé¾</span>
    </p>

    <div class="card">
        <div class="section-title" data-i18n="config_title">æˆ˜æœ¯é…ç½®</div>
        
        <div class="input-group">
            <label data-i18n="label_capacity">å‡ºå¾å®¹é‡ï¼š</label>
            <input type="number" id="totalCapacity" placeholder="160000">
        </div>

        <div class="input-group">
            <label for="rosaToggle" style="cursor: pointer; display: flex; align-items: center;">
                <input type="checkbox" id="rosaToggle"> 
                <span data-i18n="label_rosa">ä½¿ç”¨ç½—è (5çº§)</span>
            </label>
            <span style="font-size: 0.9em; color: #666; margin-left: 5px;" data-i18n="note_rosa">(å‹¾é€‰åå¼“å…µæ”»å‡»åŠ æˆé¡¹ x 1.3)</span>
        </div>

        <hr style="border: 0; border-top: 1px dashed #ddd; margin: 15px 0;">

        <div class="input-group">
            <label data-i18n="label_cav_skill">éª‘å…µé»„é‡‘æŠ€èƒ½ï¼š</label>
            <select id="cavSkill" class="tier-select">
                <option value="none" data-i18n="opt_none">æ—  / ä½äºé»„é‡‘3</option>
                <option value="g3" data-i18n="opt_g3">é»„é‡‘ 3 (10% åŒå€)</option>
                <option value="g5" data-i18n="opt_g5">é»„é‡‘ 5 (15% åŒå€)</option>
            </select>
        </div>

        <div class="input-group">
            <label data-i18n="label_arc_skill">å¼“å…µé»„é‡‘æŠ€èƒ½ï¼š</label>
            <select id="arcSkill" class="tier-select">
                <option value="none" data-i18n="opt_none">æ—  / ä½äºé»„é‡‘3</option>
                <option value="g3" data-i18n="opt_g3_arc">é»„é‡‘ 3 (20% å¢ä¼¤)</option>
                <option value="g5" data-i18n="opt_g5_arc">é»„é‡‘ 5 (30% å¢ä¼¤)</option>
            </select>
        </div>
    </div>

    <div class="card">
        <div class="section-title" data-i18n="stats_title">å…µç§é¢æ¿æ•°æ®</div>
        <table>
            <thead>
                <tr>
                    <th data-i18n="th_troop">å…µç§</th>
                    <th data-i18n="th_base_atk">åˆå§‹æ”»</th>
                    <th data-i18n="th_base_leth">åˆå§‹æ€</th>
                    <th data-i18n="th_buff_atk">åŠ æˆæ”» (%)</th>
                    <th data-i18n="th_buff_leth">åŠ æˆæ€ (%)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td data-i18n="troop_inf">ğŸ›¡ï¸ ç›¾å…µ</td>
                    <td><input type="number" class="table-input" id="inf_base_atk"></td>
                    <td><input type="number" class="table-input" id="inf_base_leth"></td>
                    <td><input type="number" class="table-input" id="inf_buff_atk"></td>
                    <td><input type="number" class="table-input" id="inf_buff_leth"></td>
                </tr>
                <tr>
                    <td data-i18n="troop_rid">ğŸ éª‘å…µ</td>
                    <td><input type="number" class="table-input" id="rid_base_atk"></td>
                    <td><input type="number" class="table-input" id="rid_base_leth"></td>
                    <td><input type="number" class="table-input" id="rid_buff_atk"></td>
                    <td><input type="number" class="table-input" id="rid_buff_leth"></td>
                </tr>
                <tr>
                    <td data-i18n="troop_hun">ğŸ¹ å¼“å…µ</td>
                    <td><input type="number" class="table-input" id="hun_base_atk"></td>
                    <td><input type="number" class="table-input" id="hun_base_leth"></td>
                    <td><input type="number" class="table-input" id="hun_buff_atk"></td>
                    <td><input type="number" class="table-input" id="hun_buff_leth"></td>
                </tr>
            </tbody>
        </table>

        <button class="btn-calc" onclick="calculateOptimalRatio()" data-i18n="btn_calc">å¼€å§‹è®¡ç®—æœ€ä½³æ¯”ä¾‹</button>
    </div>

    <div class="card" id="result-area">
        <div class="section-title" data-i18n="result_title">âš–ï¸ æœ€ä½³å‡ºå¾æ–¹æ¡ˆ</div>
        <div id="result-content"></div>
    </div>

    <div class="card feedback-area">
        <h3 data-i18n="feedback_title">ğŸ‰ å–œæ¬¢è¿™ä¸ªè®¡ç®—å™¨å—ï¼Ÿç‚¹èµæˆ–è¯„è®ºå§ï¼</h3>
        
        <div class="like-section">
            <button id="likeButton" data-i18n="like_button">ğŸ‘ ç‚¹èµ</button>
            <span id="likeCount">0</span>
        </div>

        <div class="comment-input-group">
            <textarea id="commentInput" data-i18n="comment_placeholder_attr" placeholder="è¾“å…¥æ‚¨çš„è¯„è®º..."></textarea>
            <button id="submitCommentButton" data-i18n="comment_submit">æäº¤è¯„è®º</button>
        </div>

        <h4 data-i18n="latest_comments">æœ€æ–°è¯„è®ºï¼š</h4>
        <div id="commentsList" class="comments-list">
            <p style="text-align: center; color: #999;" data-i18n="no_comments">æš‚æ— è¯„è®º</p>
        </div>
    </div>
    
    <div id="authModal">
        <div class="modal-content">
            <h3 data-i18n="modal_title">ç™»å½•æˆ–æ³¨å†Œ</h3>
            
            <input type="text" id="authUsername" placeholder="æ˜µç§° (ä»…æ³¨å†Œæ—¶éœ€è¦)" style="display: none;">
            <input type="email" id="authEmail" placeholder="é‚®ç®±">
            <input type="password" id="authPassword" placeholder="å¯†ç ">
            
            <button id="confirmAuthButton" data-i18n="btn_confirm_login">ç¡®è®¤</button>
            <p id="toggleAuthMode" data-i18n="switch_to_register">æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ</p>
        </div>
    </div>

    <div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1001; justify-content: center; align-items: center;">
        <div class="modal-content">
            <h3>ä¿®æ”¹æ‚¨çš„è¯„è®º</h3>
            <textarea id="editCommentText" style="width: calc(100% - 20px); padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; min-height: 80px;"></textarea>
            <button id="confirmEditButton" style="background-color: #3498db;">ç¡®è®¤ä¿®æ”¹</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script> 

    <script>
        // --- 1. å¤šè¯­è¨€è¯å…¸ (æ–°å¢æ˜µç§°ç›¸å…³æ–‡æœ¬) ---
        const translations = {
            "zh-CN": {
                title: "ğŸ» æ‰“ç†Šé…å…µæ¯”ä¾‹è®¡ç®—å™¨",
                author_label: "ä½œè€…",
                config_title: "æˆ˜æœ¯é…ç½®",
                label_capacity: "å‡ºå¾å®¹é‡ï¼š",
                label_rosa: "ä½¿ç”¨ç½—è (5çº§)",
                note_rosa: "(å‹¾é€‰åå¼“å…µæ”»å‡»åŠ æˆé¡¹ x 1.3)",
                label_cav_skill: "éª‘å…µé»„é‡‘æŠ€èƒ½ï¼š",
                label_arc_skill: "å¼“å…µé»„é‡‘æŠ€èƒ½ï¼š",
                opt_none: "æ—  / ä½äºé»„é‡‘3",
                opt_g3: "é»„é‡‘ 3 (10% åŒå€)",
                opt_g5: "é»„é‡‘ 5 (15% åŒå€)",
                opt_g3_arc: "é»„é‡‘ 3 (20% å¢ä¼¤)",
                opt_g5_arc: "é»„é‡‘ 5 (30% å¢ä¼¤)",
                stats_title: "å…µç§é¢æ¿æ•°æ®",
                th_troop: "å…µç§",
                th_base_atk: "åˆå§‹æ”»",
                th_base_leth: "åˆå§‹æ€",
                th_buff_atk: "åŠ æˆæ”» (%)",
                th_buff_leth: "åŠ æˆæ€ (%)",
                troop_inf: "ğŸ›¡ï¸ ç›¾å…µ",
                troop_rid: "ğŸ éª‘å…µ",
                troop_hun: "ğŸ¹ å¼“å…µ",
                btn_calc: "å¼€å§‹è®¡ç®—æœ€ä½³æ¯”ä¾‹",
                result_title: "âš–ï¸ æœ€ä½³å‡ºå¾æ–¹æ¡ˆ",
                label_total: "æ€»è®¡å…µåŠ›ï¼š",
                msg_correction: "âš ï¸ æ³¨æ„ï¼šåŸå§‹è®¡ç®—ç›¾å…µä¸è¶³ 5000ï¼Œå·²è‡ªåŠ¨è¡¥é½ï¼Œå¹¶æŒ‰æœ€ä¼˜æƒé‡é‡æ–°åˆ†é…éª‘å…µä¸å¼“å…µã€‚",
                alert_capacity: "è¯·è¾“å…¥æœ‰æ•ˆçš„å‡ºå¾å®¹é‡ï¼",
                alert_stats: "è¯·è¾“å…¥æœ‰æ•ˆçš„é¢æ¿æ•°å€¼ï¼",
                comment_placeholder_attr: "è¾“å…¥æ‚¨çš„è¯„è®º...",
                comment_submit: "æäº¤è¯„è®º",
                feedback_title: "ğŸ‰ å–œæ¬¢è¿™ä¸ªè®¡ç®—å™¨å—ï¼Ÿç‚¹èµæˆ–è¯„è®ºå§ï¼",
                like_button: "ğŸ‘ ç‚¹èµ", 
                latest_comments: "æœ€æ–°è¯„è®ºï¼š",
                no_comments: "æš‚æ— è¯„è®º",
                anonymous_user: "åŒ¿åç”¨æˆ·",
                comment_empty_alert: "è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©ºï¼",
                like_success: "ç‚¹èµæˆåŠŸï¼",
                like_error: "ç‚¹èµå¤±è´¥ï¼š",
                comment_success: "è¯„è®ºå·²æˆåŠŸæäº¤ã€‚",
                comment_error: "æäº¤è¯„è®ºå¤±è´¥ï¼š",
                
                // è¯„è®ºæ“ä½œæ–°å¢
                edit_button: "ä¿®æ”¹",
                delete_button: "åˆ é™¤",
                confirm_delete: "ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ",
                delete_success: "è¯„è®ºå·²åˆ é™¤ã€‚",
                delete_error: "åˆ é™¤å¤±è´¥ï¼š",
                edit_success: "è¯„è®ºä¿®æ”¹æˆåŠŸã€‚",
                edit_error: "è¯„è®ºä¿®æ”¹å¤±è´¥ï¼š",
                not_logged_in_like: "è¯·å…ˆç™»å½•æ‚¨çš„è´¦å·ï¼Œä»¥ä¾¿ä¿å­˜æ‚¨çš„ç‚¹èµè®°å½•ï¼", 

                // è®¤è¯ç›¸å…³æ–‡æœ¬
                btn_login: "ç™»å½•/æ³¨å†Œ",
                btn_logout: "ç™»å‡º",
                modal_title: "ç™»å½•æˆ–æ³¨å†Œ",
                btn_confirm_login: "ç¡®è®¤",
                switch_to_register: "æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ",
                switch_to_login: "å·²æœ‰è´¦å·ï¼Ÿç‚¹å‡»ç™»å½•",
                login_success: "ç™»å½•æˆåŠŸï¼",
                register_success: "æ³¨å†ŒæˆåŠŸï¼å·²è‡ªåŠ¨ç™»å½•ã€‚",
                logout_success: "å·²å®‰å…¨ç™»å‡ºã€‚",
                auth_error_prefix: "è®¤è¯å¤±è´¥ï¼š",
                // æ–°å¢æ˜µç§°ç›¸å…³
                input_username: "æ˜µç§° (å¿…å¡«)",
                alert_username_empty: "æ³¨å†Œæ—¶æ˜µç§°ä¸èƒ½ä¸ºç©ºï¼",
                default_username: "ç”¨æˆ·" // åŒ¿åç”¨æˆ·æ˜µç§°çš„åŸºç¡€
            },
            "zh-TW": {
                // ... (å…¶ä»–ç¿»è¯‘éœ€è¦åŒæ­¥æ›´æ–°)
                like_button: "ğŸ‘ é»è´Š", 
                edit_button: "ä¿®æ”¹",
                delete_button: "åˆªé™¤",
                confirm_delete: "ç¢ºå®šè¦åˆªé™¤é€™æ¢è©•è«–å—ï¼Ÿ",
                delete_success: "è©•è«–å·²åˆªé™¤ã€‚",
                delete_error: "åˆªé™¤å¤±æ•—ï¼š",
                edit_success: "è©•è«–ä¿®æ”¹æˆåŠŸã€‚",
                edit_error: "è©•è«–ä¿®æ”¹å¤±æ•—ï¼š",
                not_logged_in_like: "è«‹å…ˆç™»å…¥æ‚¨çš„å¸³è™Ÿï¼Œä»¥ä¾¿å„²å­˜æ‚¨çš„é»è´Šè¨˜éŒ„ï¼",
                input_username: "æš±ç¨± (å¿…å¡«)",
                alert_username_empty: "è¨»å†Šæ™‚æš±ç¨±ä¸èƒ½ç‚ºç©ºï¼",
                default_username: "ç”¨æˆ¶"
            },
            "en": {
                // ... (å…¶ä»–ç¿»è¯‘éœ€è¦åŒæ­¥æ›´æ–°)
                like_button: "ğŸ‘ Like", 
                edit_button: "Edit",
                delete_button: "Delete",
                confirm_delete: "Are you sure you want to delete this comment?",
                delete_success: "Comment deleted.",
                delete_error: "Deletion failed:",
                edit_success: "Comment updated successfully.",
                edit_error: "Comment update failed:",
                not_logged_in_like: "Please log in to save your like!",
                input_username: "Nickname (Required)",
                alert_username_empty: "Nickname cannot be empty during registration!",
                default_username: "User"
            },
            // ... (å…¶ä»–è¯­è¨€)
        };

        let currentLang = "zh-CN"; 
        
        function changeLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];

            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (t[key]) element.textContent = t[key];
            });
            // ç‰¹æ®Šå¤„ç† placeholder å±æ€§
            document.getElementById('commentInput').placeholder = t.comment_placeholder_attr; 
            document.getElementById('authUsername').placeholder = t.input_username;

            // æ›´æ–°ä½œè€…åç§°
            const authorNameSpan = document.getElementById('authorName');
            if (lang === 'zh-CN' || lang === 'zh-TW') {
                authorNameSpan.textContent = "#46 çƒé¾";
            } else {
                authorNameSpan.textContent = "#46 Oolong";
            }

            // æ›´æ–°ç”¨æˆ·çŠ¶æ€æ˜¾ç¤º (å¦‚æœå·²ç™»å½•ï¼Œéœ€è¦è·å–ç”¨æˆ·åï¼Œå¦åˆ™æ˜¾ç¤ºåŒ¿å)
            updateUIForUser(auth.currentUser); 
            
            if (document.getElementById('result-area').style.display === 'block') {
                calculateOptimalRatio();
            }
        }


        // Firebase é…ç½®ä¿¡æ¯ (ä½¿ç”¨æ‚¨é¡¹ç›®çš„å®é™…ä¿¡æ¯)
        const firebaseConfig = {
          apiKey: "AIzaSyDvlbYxDrqdL9Lwp1ndTs7nuwAZ2NZ8aJ8",
          authDomain: "troo-pcalculator-2.firebaseapp.com",
          databaseURL: "https://troo-pcalculator-2-default-rtdb.firebaseio.com",
          projectId: "troo-pcalculator-2",
          storageBucket: "troo-pcalculator-2.firebase-storage.app",
          messagingSenderId: "304267188046",
          appId: "1:304267188046:web:6f6e9d05a399d43089f01f"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);

        // è·å– Realtime Database å’Œ Auth çš„å¼•ç”¨
        const database = firebase.database();
        const auth = firebase.auth(); 

        let currentUserId = null;
        let currentUserName = translations["zh-CN"].anonymous_user; 

        // --- ç”¨æˆ·çŠ¶æ€ç®¡ç†æ ¸å¿ƒå‡½æ•° (ä¿®æ”¹ï¼šä»æ•°æ®åº“è·å–æ˜µç§°) ---
        function updateUIForUser(user) {
            const t = translations[currentLang];
            const displayUserName = document.getElementById('displayUserName');
            const authButton = document.getElementById('authButton');
            const logoutButton = document.getElementById('logoutButton');
            
            // é»˜è®¤è®¾ç½®ä¸ºåŒ¿åçŠ¶æ€
            currentUserId = null;
            currentUserName = t.anonymous_user;
            displayUserName.textContent = t.anonymous_user;
            authButton.style.display = 'block';
            logoutButton.style.display = 'none';

            if (user) {
                currentUserId = user.uid;

                if (!user.isAnonymous) {
                    // çœŸå®ç”¨æˆ·ç™»å½•ï¼šä»æ•°æ®åº“è·å–æ˜µç§°
                    database.ref(`users/${user.uid}/username`).once('value', (snapshot) => {
                        currentUserName = snapshot.val() || t.default_username; // å¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰æ˜µç§°ï¼Œä½¿ç”¨é»˜è®¤æ˜µç§°
                        displayUserName.textContent = currentUserName;
                    });

                    authButton.style.display = 'none';
                    logoutButton.style.display = 'block';
                } else {
                    // åŒ¿åç”¨æˆ·ç™»å½• (ä¿ç•™é»˜è®¤åŒ¿åç”¨æˆ·çŠ¶æ€)
                    displayUserName.textContent = t.anonymous_user;
                    authButton.style.display = 'block';
                    logoutButton.style.display = 'none';
                }
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            const browserLang = navigator.language.substring(0, 5); 
            let initialLang = 'zh-CN';
            if (translations[browserLang]) {
                initialLang = browserLang;
            } else if (translations[browserLang.substring(0, 2)]) {
                initialLang = browserLang.substring(0, 2);
            }
            const selector = document.getElementById('langSelector');
            if (selector) {
                selector.value = initialLang;
                changeLanguage(initialLang);
            } else {
                changeLanguage(initialLang);
            }

            // --- Firebase Authentication ç›‘å¬å™¨ (ä¿æŒä¸å˜) ---
            auth.onAuthStateChanged((user) => {
                if (user) {
                    updateUIForUser(user);
                } else {
                    // å¦‚æœç”¨æˆ·æœªç™»å½•ï¼ˆuser == nullï¼‰ï¼Œå°è¯•è¿›è¡ŒåŒ¿åç™»å½• (ç¡®ä¿è¯„è®ºå’Œç‚¹èµåŠŸèƒ½å¯ç”¨)
                    auth.signInAnonymously()
                        .then((userCredential) => {
                            updateUIForUser(userCredential.user);
                            console.log("åŒ¿åç™»å½•æˆåŠŸï¼Œç”¨æˆ·ID:", userCredential.user.uid);
                        })
                        .catch((error) => {
                            console.error("åŒ¿åç™»å½•å¤±è´¥:", error);
                        });
                }
            });

            // åˆå§‹åŒ–ç‚¹èµå’Œè¯„è®ºåŠŸèƒ½
            initFeedbackFeatures();
            setupAuthModalListeners();
        });


        // ... (calculateOptimalRatio æ ¸å¿ƒè®¡ç®—é€»è¾‘ä¿æŒä¸å˜) ...
        function calculateOptimalRatio() {
            const t = translations[currentLang]; 
            const capacity = parseFloat(document.getElementById('totalCapacity').value) || 0;
            const useRosa = document.getElementById('rosaToggle').checked;
            
            const cavSkill = document.getElementById('cavSkill').value; 
            const arcSkill = document.getElementById('arcSkill').value;

            if (capacity <= 0) {
                alert(t.alert_capacity);
                return;
            }

            function getStats(prefix) {
                return {
                    baseAtk: parseFloat(document.getElementById(prefix + '_base_atk').value) || 0,
                    baseLeth: parseFloat(document.getElementById(prefix + '_base_leth').value) || 0,
                    buffAtk: parseFloat(document.getElementById(prefix + '_buff_atk').value) || 0,
                    buffLeth: parseFloat(document.getElementById(prefix + '_buff_leth').value) || 0
                };
            }

            const inf = getStats('inf');
            const rid = getStats('rid');
            const hun = getStats('hun');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ— æ•ˆè¾“å…¥
            if ([inf, rid, hun].some(stats => stats.baseAtk === 0 && stats.baseLeth === 0)) {
                alert(t.alert_stats);
                return;
            }

            // --- è®¡ç®—å•å…µæœ‰æ•ˆå¼ºåº¦ S ---
            function calculateEffectiveStrength(stats, type, rosaActive) {
                // 1. åŸºç¡€ K å€¼
                let attackMultiplier = 1 + (stats.buffAtk / 100);
                if (type === 'hunter' && rosaActive) {
                    attackMultiplier = attackMultiplier * 1.3;
                }
                const lethalityMultiplier = 1 + (stats.buffLeth / 100);
                const k_base = stats.baseAtk * stats.baseLeth * attackMultiplier * lethalityMultiplier;

                // 2. éšè—åŠ æˆ B
                let bonusB = 0; 
                if (type === 'rider') bonusB = 0.2017;
                if (type === 'hunter') bonusB = 0.443;
                
                // 3. æŠ€èƒ½æ”¶ç›Šå› å­ F
                let skillF = 1.0;

                if (type === 'rider') {
                    if (cavSkill === 'g3') skillF = 1.1; 
                    else if (cavSkill === 'g5') skillF = 1.15;
                }

                if (type === 'hunter') {
                    const baseSkillF = 1.1; // åŸºç¡€è¿å°„
                    let goldSkillF = 1.0;
                    if (arcSkill === 'g3') goldSkillF = 1.1;
                    else if (arcSkill === 'g5') goldSkillF = 1.15;
                    skillF = baseSkillF * goldSkillF;
                }

                // æœ€ç»ˆå•å…µå¼ºåº¦ S
                return k_base * (1 + bonusB) * skillF;
            }

            const s_inf = calculateEffectiveStrength(inf, 'infantry', useRosa);
            const s_rid = calculateEffectiveStrength(rid, 'rider', useRosa);
            const s_hun = calculateEffectiveStrength(hun, 'hunter', useRosa);

            // æƒé‡ W = S^2
            const w_inf = s_inf * s_inf;
            const w_rid = s_rid * s_rid;
            const w_hun = s_hun * s_hun;
            const totalWeight = w_inf + w_rid + w_hun;

            if (totalWeight === 0) {
                alert(t.alert_stats);
                return;
            }

            // --- åˆ†é…é€»è¾‘æ›´æ–° ---
            let rawCountInf = capacity * (w_inf / totalWeight);
            
            let finalInf = Math.round(rawCountInf);
            let finalRid = 0;
            let finalHun = 0;
            let correctionMsg = "";

            const MIN_INFANTRY = 5000;

            if (finalInf < MIN_INFANTRY) {
                // 1. å¼ºåˆ¶è®¾ç½®ç›¾å…µä¸ºæœ€å°å€¼
                finalInf = Math.min(MIN_INFANTRY, capacity);
                
                // 2. è®¡ç®—å‰©ä½™å¯ç”¨å®¹é‡
                let remainingCapacity = capacity - finalInf;
                if (remainingCapacity < 0) remainingCapacity = 0;

                // 3. å‰©ä½™å®¹é‡åœ¨éª‘å…µå’Œå¼“å…µä¹‹é—´æŒ‰ S^2 æ¯”ä¾‹åˆ†é…
                const weightRemaining = w_rid + w_hun;
                
                if (weightRemaining > 0) {
                    finalRid = Math.round(remainingCapacity * (w_rid / weightRemaining));
                    finalHun = remainingCapacity - finalRid; // å¼“å…µç”¨å‡æ³•ï¼Œç¡®ä¿æ€»å’Œæ­£ç¡®
                } else {
                    finalRid = 0;
                    finalHun = remainingCapacity;
                }

                // æç¤ºä¿®æ­£ä¿¡æ¯
                if (capacity > MIN_INFANTRY) {
                    correctionMsg = `<div class="notice">${t.msg_correction} (${Math.round(rawCountInf).toLocaleString()})</div>`;
                }
            } else {
                // æ­£å¸¸æƒ…å†µï¼šä¸éœ€è¦ä¿®æ­£
                finalRid = Math.round(capacity * (w_rid / totalWeight));
                finalHun = capacity - finalInf - finalRid;
            }

            // --- æ¸²æŸ“ç»“æœ ---
            const resultArea = document.getElementById('result-area');
            const resultContent = document.getElementById('result-content');
            
            resultArea.style.display = 'block';
            
            const pInf = ((finalInf / capacity) * 100).toFixed(2);
            const pRid = ((finalRid / capacity) * 100).toFixed(2);
            const pHun = ((finalHun / capacity) * 100).toFixed(2);

            resultContent.innerHTML = `
                <div class="result-row">
                    <span>${t.troop_inf}</span>
                    <span><span class="result-highlight">${finalInf.toLocaleString()}</span> (${pInf}%)</span>
                </div>
                <div class="result-row">
                    <span>${t.troop_rid}</span>
                    <span><span class="result-highlight">${finalRid.toLocaleString()}</span> (${pRid}%)</span>
                </div>
                <div class="result-row">
                    <span>${t.troop_hun}</span>
                    <span><span class="result-highlight">${finalHun.toLocaleString()}</span> (${pHun}%)</span>
                </div>
                <div style="margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;">
                    <strong>${t.label_total}</strong> ${ (finalInf + finalRid + finalHun).toLocaleString() }
                </div>
                ${correctionMsg}
            `;
        }


        // ... (editComment å’Œ deleteComment å‡½æ•°ä¿æŒä¸å˜) ...
        window.editComment = function(commentId, currentText) {
            const t = translations[currentLang];
            const editModal = document.getElementById('editModal');
            const editCommentText = document.getElementById('editCommentText');
            const confirmEditButton = document.getElementById('confirmEditButton');
            
            editCommentText.value = currentText;
            editModal.style.display = 'flex';

            // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…å¤šæ¬¡è§¦å‘
            confirmEditButton.replaceWith(confirmEditButton.cloneNode(true));
            const newConfirmEditButton = document.getElementById('confirmEditButton');

            newConfirmEditButton.addEventListener('click', () => {
                const newText = editCommentText.value.trim();
                if (!newText) {
                    alert(t.comment_empty_alert);
                    return;
                }

                database.ref(`calculator_data/comments/${commentId}`).update({
                    text: newText,
                    timestamp_edited: firebase.database.ServerValue.TIMESTAMP // è®°å½•ä¿®æ”¹æ—¶é—´
                })
                .then(() => {
                    alert(t.edit_success);
                    editModal.style.display = 'none';
                })
                .catch(error => {
                    console.error(t.edit_error, error);
                    alert(t.edit_error + error.message);
                });
            });

            // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
            editModal.addEventListener('click', (e) => {
                if (e.target === editModal) {
                    editModal.style.display = 'none';
                }
            });
        };

        window.deleteComment = function(commentId) {
            const t = translations[currentLang];
            if (confirm(t.confirm_delete)) {
                database.ref(`calculator_data/comments/${commentId}`).remove()
                    .then(() => {
                        alert(t.delete_success);
                    })
                    .catch(error => {
                        console.error(t.delete_error, error);
                        alert(t.delete_error + error.message);
                    });
            }
        };


        // ... (initFeedbackFeatures å‡½æ•°ä¿æŒä¸å˜) ...
        function initFeedbackFeatures() {
            const t = translations[currentLang];
            const likeButton = document.getElementById('likeButton');
            const likeCountSpan = document.getElementById('likeCount');
            const commentInput = document.getElementById('commentInput');
            const submitCommentButton = document.getElementById('submitCommentButton');
            const commentsList = document.getElementById('commentsList');

            // 1. å®æ—¶æ›´æ–°ç‚¹èµæ€»æ•°
            const calculatorLikesCountRef = database.ref('calculator_data/likes_count');
            calculatorLikesCountRef.on('value', (snapshot) => {
                const currentLikes = snapshot.val() || 0;
                likeCountSpan.textContent = currentLikes;
            });

            // 2. å¤„ç†ç‚¹èµæŒ‰é’®ç‚¹å‡» (æ–°å¢éåŒ¿åç”¨æˆ·æ£€æŸ¥)
            likeButton.addEventListener('click', () => {
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½• (éåŒ¿å)
                if (!currentUserId || auth.currentUser.isAnonymous) {
                    alert(t.not_logged_in_like);
                    return;
                }

                const userLikedRef = database.ref(`calculator_data/users_who_liked/${currentUserId}`);
                userLikedRef.transaction((currentValue) => {
                    if (currentValue === null) { 
                        // ç”¨æˆ·ç‚¹èµ
                        calculatorLikesCountRef.transaction((count) => (count || 0) + 1); 
                        alert(t.like_success);
                        return true; 
                    } else { 
                        // ç”¨æˆ·å–æ¶ˆç‚¹èµ
                        calculatorLikesCountRef.transaction((count) => (count > 0 ? count - 1 : 0)); 
                        alert("å·²å–æ¶ˆç‚¹èµ"); 
                        return null; 
                    }
                }).catch((error) => {
                    console.error(t.like_error, error);
                    alert(t.like_error + error.message);
                });
            });

            // 3. å¤„ç†æäº¤è¯„è®ºæŒ‰é’®ç‚¹å‡» 
            submitCommentButton.addEventListener('click', () => {
                if (!currentUserId) {
                    alert("æ­£åœ¨è·å–ç”¨æˆ·èº«ä»½ï¼Œè¯·ç¨å€™å†è¯•ã€‚");
                    return;
                }

                // å¼ºåˆ¶è¦æ±‚éåŒ¿åç”¨æˆ·æ‰èƒ½è¯„è®º
                 if (auth.currentUser.isAnonymous) {
                    alert("è¯·å…ˆç™»å½•æˆ–æ³¨å†Œæ‚¨çš„è´¦å·ï¼Œä»¥ä¾¿ä¿å­˜æ‚¨çš„è¯„è®ºè®°å½•ï¼");
                    return;
                }

                const commentText = commentInput.value.trim();
                if (commentText) {
                    const newCommentRef = database.ref('calculator_data/comments').push(); 
                    newCommentRef.set({
                        user_id: currentUserId,
                        username: currentUserName, // ä½¿ç”¨å½“å‰ç”¨æˆ·æ˜µç§°
                        text: commentText,
                        timestamp: firebase.database.ServerValue.TIMESTAMP 
                    })
                    .then(() => {
                        alert(t.comment_success);
                        commentInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
                    })
                    .catch((error) => {
                        console.error(t.comment_error, error);
                        alert(t.comment_error + error.message);
                    });
                } else {
                    alert(t.comment_empty_alert);
                }
            });

            // 4. å®æ—¶åŠ è½½è¯„è®º (ä¿æŒä¸å˜)
            const commentsRef = database.ref('calculator_data/comments').orderByChild('timestamp').limitToLast(10); 
            commentsRef.on('value', (snapshot) => {
                const comments = [];
                snapshot.forEach((childSnapshot) => {
                    comments.push({
                        ...childSnapshot.val(),
                        id: childSnapshot.key
                    });
                });
                
                comments.reverse();

                let html = '';
                if (comments.length === 0) {
                    html = `<p style="text-align: center; color: #999;" data-i18n="no_comments">${t.no_comments}</p>`;
                } else {
                    comments.forEach(comment => {
                        const date = new Date(comment.timestamp);
                        // ç¡®ä¿æ˜¯å½“å‰ç™»å½•çš„éåŒ¿åç”¨æˆ·æ‰èƒ½çœ‹åˆ°æ“ä½œæŒ‰é’®
                        const isOwner = comment.user_id === currentUserId && currentUserId !== null && auth.currentUser && !auth.currentUser.isAnonymous; 

                        let actionButtons = '';
                        if (isOwner) {
                            // è¯„è®ºç®¡ç†æŒ‰é’®
                            actionButtons = `
                                <div class="comment-actions">
                                    <button onclick="editComment('${comment.id}', \`${comment.text}\`)" data-i18n="edit_button">${t.edit_button}</button>
                                    <button onclick="deleteComment('${comment.id}')" data-i18n="delete_button">${t.delete_button}</button>
                                </div>
                            `;
                        }

                        html += `
                            <div class="comment-item">
                                <div class="comment-author">${comment.username}</div>
                                <div class="comment-text">${comment.text}</div>
                                <div class="comment-time">${date.toLocaleString(currentLang)}</div>
                                ${actionButtons}
                            </div>
                        `;
                    });
                }
                commentsList.innerHTML = html;
            });
        }

        // --- ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡†é€»è¾‘ (ä¿®æ”¹ï¼šå¤„ç†æ˜µç§°è¾“å…¥) ---
        function setupAuthModalListeners() {
            const t = translations[currentLang];
            const authButton = document.getElementById('authButton');
            const logoutButton = document.getElementById('logoutButton');
            const authModal = document.getElementById('authModal');
            const confirmAuthButton = document.getElementById('confirmAuthButton');
            const toggleAuthMode = document.getElementById('toggleAuthMode');
            
            const authUsername = document.getElementById('authUsername'); // æ˜µç§°
            const authEmail = document.getElementById('authEmail');
            const authPassword = document.getElementById('authPassword');
            
            let isRegisterMode = false;

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            authButton.addEventListener('click', () => {
                isRegisterMode = false; // é»˜è®¤åˆ‡æ¢åˆ°ç™»å½•æ¨¡å¼
                authModal.style.display = 'flex';
                confirmAuthButton.textContent = t.btn_confirm_login;
                toggleAuthMode.textContent = t.switch_to_register;
                
                // ç™»å½•æ¨¡å¼ä¸‹éšè—æ˜µç§°è¾“å…¥æ¡†
                authUsername.style.display = 'none';
                authUsername.value = '';

                authEmail.value = '';
                authPassword.value = '';
            });

            // ç™»å‡ºé€»è¾‘
            logoutButton.addEventListener('click', () => {
                auth.signOut().then(() => {
                    alert(t.logout_success);
                }).catch((error) => {
                    console.error("ç™»å‡ºå¤±è´¥:", error);
                });
            });

            // åˆ‡æ¢ç™»å½•/æ³¨å†Œæ¨¡å¼
            toggleAuthMode.addEventListener('click', () => {
                isRegisterMode = !isRegisterMode;
                confirmAuthButton.textContent = isRegisterMode ? t.comment_submit : t.btn_confirm_login;
                toggleAuthMode.textContent = isRegisterMode ? t.switch_to_login : t.switch_to_register;
                
                // æ³¨å†Œæ¨¡å¼ä¸‹æ˜¾ç¤ºæ˜µç§°è¾“å…¥æ¡†
                authUsername.style.display = isRegisterMode ? 'block' : 'none';
                authUsername.placeholder = t.input_username; 

                authEmail.value = '';
                authPassword.value = '';
                authUsername.value = '';
                authPassword.placeholder = "å¯†ç  (è‡³å°‘6ä½)";
            });

            // ç¡®è®¤ç™»å½•/æ³¨å†Œ
            confirmAuthButton.addEventListener('click', () => {
                const email = authEmail.value;
                const password = authPassword.value;
                const username = authUsername.value.trim();

                if (!email || password.length < 6) {
                    alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±å’Œè‡³å°‘6ä½å¯†ç ã€‚");
                    return;
                }
                
                if (isRegisterMode && !username) {
                    alert(t.alert_username_empty);
                    return;
                }

                if (isRegisterMode) {
                    // æ³¨å†Œ
                    auth.createUserWithEmailAndPassword(email, password)
                        .then((userCredential) => {
                            // æ³¨å†ŒæˆåŠŸåï¼Œä¿å­˜ç”¨æˆ·è‡ªå®šä¹‰æ˜µç§°
                            return database.ref(`users/${userCredential.user.uid}/username`).set(username)
                                .then(() => userCredential); // å°† userCredential ä¼ é€’ç»™ä¸‹ä¸€ä¸ª then
                        })
                        .then(() => {
                            alert(t.register_success);
                            authModal.style.display = 'none';
                            // onAuthStateChanged ä¼šè´Ÿè´£ UI æ›´æ–°
                        })
                        .catch((error) => {
                            alert(t.auth_error_prefix + error.message);
                        });
                } else {
                    // ç™»å½•
                    auth.signInWithEmailAndPassword(email, password)
                        .then(() => {
                            alert(t.login_success);
                            authModal.style.display = 'none';
                            // onAuthStateChanged ä¼šè´Ÿè´£ UI æ›´æ–°
                        })
                        .catch((error) => {
                            alert(t.auth_error_prefix + error.message);
                        });
                }
            });

            // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
            authModal.addEventListener('click', (e) => {
                if (e.target === authModal) {
                    authModal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
